#!/bin/bash
# ============================================================================
# IP 黑名单自动更新脚本（智能处理版）
# 从 firehol/blocklist-ipsets 和 stamparm/ipsum 获取最新 IP
# 
# 智能处理策略：
#   - 国外 IP：自动扩展到 C 段(/24)
#   - 国内 IP：保持单个 IP，避免误封家庭用户
#   - 网段类型：原样封禁
#
# 用法: chmod +x auto_block_update.sh && ./auto_block_update.sh
# 定时任务: 0 4 * * * /path/to/auto_block_update.sh >> /var/log/ip_block_update.log 2>&1
# ============================================================================

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# 获取脚本所在目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# 配置
TEMP_DIR="/tmp/blocklist_update"
LOG_FILE="/var/log/ip_block_update.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')
DATE_SHORT=$(date '+%Y-%m-%d')

# 日志目录配置
LOG_DIR="/var/log/ip_block_logs"
DAILY_LOG_DIR="$LOG_DIR/$DATE_SHORT"
NEW_IPS_LOG="$DAILY_LOG_DIR/new_blocked_ips.txt"
SUMMARY_LOG="$DAILY_LOG_DIR/summary.txt"
WHITELIST_SKIP_LOG="$DAILY_LOG_DIR/whitelist_skipped.txt"

# 创建临时目录
mkdir -p "$TEMP_DIR"

# 创建日志目录
mkdir -p "$DAILY_LOG_DIR"

echo "=========================================="
echo "[$DATE] IP 黑名单自动更新开始（智能处理版）"
echo "=========================================="

# ========== 加载统一白名单配置 ==========
echo ""
echo -e "${CYAN}========== 加载白名单配置 ==========${NC}"

if [[ -f "$SCRIPT_DIR/whitelist_config.sh" ]]; then
    source "$SCRIPT_DIR/whitelist_config.sh"
    echo -e "${GREEN}[完成]${NC} 已加载统一白名单配置"
else
    echo -e "${RED}[错误]${NC} 找不到 whitelist_config.sh，请确保该文件与脚本在同一目录"
    exit 1
fi

# ========== 管理员 IP 白名单（只添加这些到 iptables）==========
# 注意：不再添加服务器自身 IP 到 iptables（那样做是错误的！）
# 百度蜘蛛等 IP 已在 whitelist_config.sh 中配置，用于脚本内部判断
ADMIN_WHITELIST_IPS=(
    "124.13.164.0/24"       # 马来西亚 IP
    "116.102.181.220"       # 你的 IP
    "203.168.241.16"
    "182.239.114.239"
    "115.135.30.121"
    "127.0.0.1"             # 本机回环
)

echo ""
echo "添加管理员白名单到 iptables："
ADMIN_COUNT=0
for ip in "${ADMIN_WHITELIST_IPS[@]}"; do
    [[ -z "$ip" ]] && continue
    
    if ! iptables -C INPUT -s "$ip" -j ACCEPT 2>/dev/null; then
        iptables -I INPUT 1 -s "$ip" -j ACCEPT
        echo -e "   ${GREEN}[新增]${NC} $ip"
    else
        echo -e "   ${YELLOW}[已存在]${NC} $ip"
    fi
    ((ADMIN_COUNT++))
done
echo -e "   共 ${GREEN}$ADMIN_COUNT${NC} 个管理员白名单"
echo ""

# 显示服务器 IP 信息（不添加到 iptables）
SERVER_IPS=$(ip addr show 2>/dev/null | grep -oP 'inet \K[\d.]+' | grep -v '^127\.' | sort -u)
SERVER_IP_COUNT=$(echo "$SERVER_IPS" | grep -c . 2>/dev/null || echo 0)
echo -e "${CYAN}[信息]${NC} 检测到服务器有 $SERVER_IP_COUNT 个 IP（不添加到 iptables 白名单）"
echo ""

# 注意：is_whitelisted 函数已在 whitelist_config.sh 中定义

# 获取 ctstate ESTABLISHED 规则的行号（用于在其前面插入 DROP 规则）
# 这样 DROP 规则会在所有放行规则之前生效
get_insert_line() {
    local line=$(iptables -L INPUT -n --line-numbers 2>/dev/null | \
        grep -E "ESTABLISHED|ctstate" | \
        head -1 | \
        awk '{print $1}')
    
    # 如果没找到 ctstate，尝试找 REJECT
    if [[ -z "$line" ]]; then
        line=$(iptables -L INPUT -n --line-numbers 2>/dev/null | \
            grep -i "REJECT" | \
            head -1 | \
            awk '{print $1}')
    fi
    
    echo "$line"
}

# ========== 定义要下载的黑名单 ==========
# 格式: "URL|类型(netset/ipset/ipsum)|名称"
# ipsum 类型会按分数过滤，只封禁高分 IP
#
# ★★★ ipsum 项目说明 ★★★
# 数字代表该 IP 被多少个黑名单收录：
#   1.txt = 出现在 1+ 个黑名单（最多IP，但可能有误报）
#   2.txt = 出现在 2+ 个黑名单
#   3.txt = 出现在 3+ 个黑名单（推荐起点）
#   5.txt = 出现在 5+ 个黑名单（可靠）
#   8.txt = 出现在 8+ 个黑名单（最危险，最可靠）
# 数字越大 = IP越少 = 越危险 = 误报率越低
#
BLOCKLISTS=(
    # =============================================================
    # ===== FireHOL 分级聚合黑名单（★★★ 核心推荐 ★★★）=====
    # =============================================================
    # FireHOL 已将多个优质黑名单按风险等级聚合，直接使用即可
    #
    # Level 1: 包含 dshield, feodo, fullbogons, spamhaus_drop, spamhaus_edrop
    #          适合所有服务器基础保护，误报率极低
    # 注意：Level1 包含 fullbogons（未分配IP段），可能封禁较多，按需使用
    "https://raw.githubusercontent.com/firehol/blocklist-ipsets/master/firehol_level1.netset|netset|FireHOL_L1_基础保护"
    
    # Level 2: 包含 blocklist_de, dshield_1d, greensnow
    #          48小时内攻击源，误报率低（★★★ 必封）
    "https://raw.githubusercontent.com/firehol/blocklist-ipsets/master/firehol_level2.netset|netset|FireHOL_L2_48h攻击"
    
    # Level 3: 包含 bruteforceblocker, ciarmy, dshield_30d, myip, vxvault
    #          30天内攻击/病毒/间谍软件，误报率中等（★★ 推荐）
    "https://raw.githubusercontent.com/firehol/blocklist-ipsets/master/firehol_level3.netset|netset|FireHOL_L3_30d攻击"
    
    # Level 4: 包含 blocklist_net_ua, botscout_30d, cybercrime, iblocklist_*
    #          可能有较多误报（★ 谨慎使用）
    # "https://raw.githubusercontent.com/firehol/blocklist-ipsets/master/firehol_level4.netset|netset|FireHOL_L4_谨慎使用"
    
    # =============================================================
    # ===== stamparm/ipsum 项目（多源交叉验证）=====
    # =============================================================
    # 数字代表被多少个黑名单收录，越大越危险
    # Level 3+ 即可，太低可能误报
    "https://raw.githubusercontent.com/stamparm/ipsum/master/levels/8.txt|ipsum|IPsum_L8_最危险"
    "https://raw.githubusercontent.com/stamparm/ipsum/master/levels/7.txt|ipsum|IPsum_L7"
    "https://raw.githubusercontent.com/stamparm/ipsum/master/levels/6.txt|ipsum|IPsum_L6"
    "https://raw.githubusercontent.com/stamparm/ipsum/master/levels/5.txt|ipsum|IPsum_L5"
    "https://raw.githubusercontent.com/stamparm/ipsum/master/levels/4.txt|ipsum|IPsum_L4"
    "https://raw.githubusercontent.com/stamparm/ipsum/master/levels/3.txt|ipsum|IPsum_L3"
    
)

# ========== 中国 IP 段前缀（用于判断是否为国内 IP）==========
# 常见的中国 IP 前缀（前两位）
CHINA_IP_PREFIXES=(
    "1.0" "1.1" "1.2" "1.4" "1.8" "1.12" "1.24" "1.45" "1.48" "1.56" "1.68" "1.80" "1.116" "1.180" "1.188" "1.192" "1.200" "1.204"
    "14.0" "14.16" "14.104" "14.112" "14.116" "14.120" "14.128" "14.144" "14.192" "14.204" "14.208"
    "27.0" "27.8" "27.16" "27.36" "27.40" "27.50" "27.54" "27.98" "27.106" "27.115" "27.148" "27.184" "27.224"
    "36.0" "36.16" "36.32" "36.48" "36.56" "36.96" "36.128" "36.248"
    "39.64" "39.128" "39.144" "39.156" "39.160"
    "42.0" "42.4" "42.48" "42.56" "42.84" "42.96" "42.120" "42.156" "42.176" "42.224" "42.240"
    "49.4" "49.52" "49.64" "49.112" "49.128" "49.140"
    "58.0" "58.16" "58.32" "58.48" "58.56" "58.192" "58.208" "58.240" "58.248" "58.252"
    "59.32" "59.36" "59.40" "59.44" "59.48" "59.52" "59.56" "59.60" "59.108" "59.172"
    "60.0" "60.8" "60.10" "60.12" "60.16" "60.24" "60.28" "60.160" "60.168" "60.176" "60.190" "60.194" "60.208" "60.216" "60.220"
    "61.4" "61.128" "61.132" "61.136" "61.144" "61.160" "61.176" "61.183" "61.232" "61.240"
    "101.0" "101.4" "101.16" "101.24" "101.32" "101.36" "101.40" "101.48" "101.64" "101.80" "101.96" "101.200" "101.224" "101.226" "101.228" "101.230"
    "106.0" "106.2" "106.4" "106.8" "106.32" "106.36" "106.56" "106.80" "106.108" "106.112" "106.224"
    "110.0" "110.6" "110.16" "110.40" "110.51" "110.52" "110.56" "110.72" "110.80" "110.88" "110.152" "110.156" "110.166" "110.172" "110.176" "110.184" "110.240"
    "111.0" "111.4" "111.8" "111.12" "111.20" "111.30" "111.32" "111.56" "111.72" "111.112" "111.120" "111.160" "111.172" "111.176" "111.224" "111.228"
    "112.0" "112.4" "112.16" "112.24" "112.64" "112.80" "112.88" "112.96" "112.100" "112.111" "112.112" "112.128" "112.192" "112.224" "112.240"
    "113.0" "113.8" "113.12" "113.16" "113.24" "113.52" "113.56" "113.62" "113.64" "113.80" "113.96" "113.100" "113.108" "113.116" "113.120" "113.128" "113.136" "113.194" "113.200" "113.204" "113.208" "113.212" "113.218" "113.224" "113.240"
    "114.28" "114.32" "114.48" "114.54" "114.60" "114.64" "114.80" "114.96" "114.104" "114.112" "114.132" "114.138" "114.216" "114.220" "114.224" "114.228" "114.232" "114.240" "114.244" "114.248" "114.250"
    "115.24" "115.28" "115.32" "115.48" "115.56" "115.60" "115.84" "115.100" "115.148" "115.152" "115.168" "115.192" "115.200" "115.212" "115.224" "115.236"
    "116.0" "116.1" "116.2" "116.4" "116.8" "116.16" "116.52" "116.56" "116.60" "116.62" "116.76" "116.90" "116.112" "116.116" "116.128" "116.136" "116.162" "116.192" "116.196" "116.204" "116.207" "116.208" "116.224" "116.228" "116.232" "116.236" "116.246" "116.248" "116.252"
    "117.8" "117.21" "117.22" "117.24" "117.32" "117.34" "117.40" "117.44" "117.60" "117.64" "117.80" "117.100" "117.106" "117.120" "117.128" "117.131" "117.132" "117.136" "117.140" "117.144" "117.148" "117.156" "117.160" "117.176"
    "118.24" "118.26" "118.28" "118.72" "118.74" "118.76" "118.80" "118.84" "118.88" "118.112" "118.116" "118.120" "118.122" "118.132" "118.144" "118.180" "118.186" "118.192" "118.212" "118.228" "118.239" "118.240" "118.244" "118.248" "118.250"
    "119.0" "119.2" "119.4" "119.6" "119.8" "119.16" "119.28" "119.32" "119.36" "119.40" "119.48" "119.57" "119.60" "119.84" "119.96" "119.108" "119.112" "119.120" "119.128" "119.144" "119.148" "119.176" "119.232" "119.248"
    "120.0" "120.4" "120.8" "120.24" "120.30" "120.32" "120.36" "120.40" "120.52" "120.64" "120.68" "120.76" "120.80" "120.84" "120.88" "120.92" "120.128" "120.132" "120.136" "120.192" "120.196" "120.200" "120.204" "120.208" "120.224" "120.232" "120.236" "120.240" "120.244"
    "121.0" "121.4" "121.8" "121.12" "121.16" "121.24" "121.28" "121.32" "121.36" "121.40" "121.48" "121.52" "121.56" "121.60" "121.68" "121.76" "121.196" "121.200" "121.204" "121.224" "121.228" "121.232" "121.248"
    "122.0" "122.4" "122.8" "122.48" "122.64" "122.68" "122.70" "122.72" "122.80" "122.84" "122.88" "122.96" "122.112" "122.136" "122.156" "122.188" "122.192" "122.198" "122.200" "122.224" "122.228" "122.232" "122.240"
    "123.0" "123.4" "123.8" "123.52" "123.56" "123.64" "123.72" "123.76" "123.80" "123.84" "123.88" "123.96" "123.100" "123.108" "123.112" "123.120" "123.125" "123.128" "123.132" "123.136" "123.144" "123.148" "123.152" "123.160" "123.164" "123.168" "123.172" "123.176" "123.180" "123.184" "123.188" "123.196" "123.206" "123.232" "123.240" "123.244" "123.249"
    "124.0" "124.4" "124.8" "124.16" "124.20" "124.28" "124.31" "124.64" "124.66" "124.68" "124.72" "124.76" "124.88" "124.108" "124.112" "124.114" "124.116" "124.118" "124.126" "124.128" "124.152" "124.156" "124.160" "124.162" "124.164" "124.166" "124.172" "124.192" "124.196" "124.200" "124.204" "124.224" "124.228" "124.232" "124.236" "124.240" "124.248"
    "125.32" "125.33" "125.34" "125.35" "125.36" "125.37" "125.38" "125.39" "125.40" "125.42" "125.44" "125.46" "125.48" "125.56" "125.64" "125.72" "125.76" "125.80" "125.84" "125.88" "125.104" "125.112" "125.116" "125.120"
    "180.76" "180.84" "180.88" "180.96" "180.97" "180.98" "180.100" "180.101" "180.102" "180.104" "180.106" "180.108" "180.110" "180.112" "180.116" "180.118" "180.120" "180.124" "180.126" "180.136" "180.140" "180.148" "180.149" "180.150" "180.152" "180.154" "180.156" "180.158" "180.160" "180.162" "180.164" "180.166" "180.168" "180.172" "180.175" "180.176" "180.184" "180.188" "180.200" "180.208" "180.212"
    "182.18" "182.32" "182.34" "182.36" "182.38" "182.40" "182.44" "182.48" "182.80" "182.84" "182.88" "182.90" "182.92" "182.96" "182.98" "182.100" "182.104" "182.108" "182.112" "182.116" "182.120" "182.124" "182.128" "182.129" "182.130" "182.131" "182.136" "182.138" "182.140" "182.144" "182.148" "182.200" "182.204" "182.236" "182.240" "182.244"
    "183.0" "183.2" "183.4" "183.6" "183.8" "183.10" "183.11" "183.12" "183.14" "183.16" "183.18" "183.20" "183.24" "183.56" "183.60" "183.61" "183.62" "183.64" "183.66" "183.68" "183.70" "183.71" "183.78" "183.80" "183.84" "183.88" "183.92" "183.128" "183.130" "183.132" "183.134" "183.136" "183.140" "183.144" "183.148" "183.152" "183.156" "183.160" "183.166" "183.168" "183.170" "183.172" "183.174" "183.176" "183.180" "183.184" "183.188" "183.192" "183.196" "183.200" "183.204" "183.208" "183.212" "183.216" "183.220" "183.224" "183.228" "183.232" "183.236" "183.240"
    "202.96" "202.97" "202.98" "202.99" "202.100" "202.101" "202.102" "202.103" "202.104" "202.105" "202.106" "202.107" "202.108" "202.110" "202.111" "202.112"
    "210.5" "210.12" "210.13" "210.14" "210.21" "210.22" "210.25" "210.26" "210.27" "210.28" "210.29" "210.30" "210.31" "210.32" "210.34" "210.35" "210.36" "210.37" "210.38" "210.39" "210.40" "210.41" "210.42" "210.43" "210.44" "210.45" "210.46" "210.47" "210.51" "210.52" "210.53"
    "211.64" "211.65" "211.66" "211.67" "211.68" "211.69" "211.70" "211.71" "211.72" "211.76" "211.80" "211.81" "211.82" "211.83" "211.84" "211.85" "211.86" "211.87" "211.88" "211.89" "211.90" "211.91" "211.92" "211.93" "211.94" "211.95" "211.96" "211.97" "211.98" "211.99" "211.100" "211.101" "211.102" "211.136" "211.137" "211.138" "211.139" "211.140" "211.141" "211.142" "211.143" "211.144" "211.145" "211.146" "211.147" "211.148" "211.149" "211.150" "211.151" "211.152" "211.153" "211.154" "211.155" "211.156" "211.157" "211.158" "211.159" "211.160" "211.161"
    "218.0" "218.1" "218.2" "218.3" "218.4" "218.5" "218.6" "218.7" "218.8" "218.9" "218.10" "218.11" "218.12" "218.20" "218.21" "218.22" "218.23" "218.24" "218.25" "218.26" "218.27" "218.28" "218.29" "218.30" "218.56" "218.57" "218.58" "218.59" "218.60" "218.61" "218.62" "218.63" "218.64" "218.65" "218.66" "218.67" "218.68" "218.69" "218.70" "218.71" "218.72" "218.73" "218.74" "218.75" "218.76" "218.77" "218.78" "218.79" "218.80" "218.81" "218.82" "218.83" "218.84" "218.85" "218.86" "218.87" "218.88" "218.89" "218.90" "218.91" "218.92" "218.93" "218.94" "218.104" "218.108"
    "219.128" "219.129" "219.130" "219.131" "219.132" "219.133" "219.134" "219.135" "219.136" "219.137" "219.138" "219.139" "219.140" "219.141" "219.142" "219.143" "219.144" "219.145" "219.146" "219.147" "219.148" "219.149" "219.150" "219.151" "219.152" "219.153" "219.154" "219.155" "219.156" "219.157" "219.158" "219.159"
    "220.112" "220.113" "220.114" "220.115" "220.160" "220.161" "220.162" "220.163" "220.164" "220.165" "220.166" "220.167" "220.168" "220.169" "220.170" "220.171" "220.172" "220.173" "220.174" "220.175" "220.176" "220.177" "220.178" "220.179" "220.180" "220.181" "220.182" "220.183" "220.184" "220.185" "220.186" "220.187" "220.188" "220.189" "220.190" "220.191" "220.192" "220.193" "220.194" "220.195" "220.196" "220.197" "220.198" "220.200" "220.201" "220.202" "220.203" "220.204" "220.205" "220.206" "220.207" "220.248" "220.249" "220.250" "220.251" "220.252"
    "221.0" "221.1" "221.2" "221.3" "221.4" "221.5" "221.6" "221.7" "221.8" "221.9" "221.10" "221.11" "221.12" "221.13" "221.14" "221.15" "221.122" "221.123" "221.124" "221.125" "221.126" "221.127" "221.128" "221.129" "221.130" "221.131" "221.172" "221.176" "221.178" "221.179" "221.180" "221.181" "221.182" "221.183" "221.192" "221.194" "221.195" "221.196" "221.198" "221.199" "221.200" "221.201" "221.202" "221.203" "221.204" "221.206" "221.207" "221.208" "221.210" "221.211" "221.212" "221.213" "221.214" "221.215" "221.216" "221.217" "221.218" "221.219" "221.220" "221.221" "221.222" "221.223" "221.224" "221.225" "221.226" "221.227" "221.228" "221.229" "221.230" "221.231" "221.232" "221.233" "221.234" "221.235" "221.236" "221.237" "221.238"
    "222.16" "222.17" "222.18" "222.19" "222.20" "222.21" "222.22" "222.23" "222.24" "222.25" "222.26" "222.27" "222.28" "222.29" "222.32" "222.34" "222.35" "222.36" "222.37" "222.38" "222.39" "222.40" "222.41" "222.42" "222.43" "222.44" "222.45" "222.46" "222.47" "222.48" "222.49" "222.50" "222.51" "222.52" "222.53" "222.54" "222.55" "222.56" "222.57" "222.58" "222.59" "222.60" "222.61" "222.62" "222.63" "222.64" "222.65" "222.66" "222.67" "222.68" "222.69" "222.70" "222.71" "222.72" "222.73" "222.74" "222.76" "222.77" "222.78" "222.79" "222.80" "222.82" "222.83" "222.84" "222.85" "222.86" "222.87" "222.88" "222.89" "222.90" "222.91" "222.92" "222.93" "222.125" "222.126" "222.128" "222.129" "222.130" "222.131" "222.132" "222.133" "222.134" "222.135" "222.136" "222.137" "222.138" "222.139" "222.140" "222.141" "222.142" "222.143" "222.160" "222.161" "222.168" "222.169" "222.170" "222.171" "222.172" "222.173" "222.174" "222.175" "222.176" "222.177" "222.178" "222.179" "222.180" "222.181" "222.182" "222.183" "222.184" "222.185" "222.186" "222.187" "222.188" "222.189" "222.190" "222.191" "222.192" "222.193" "222.194" "222.195" "222.196" "222.197" "222.198" "222.199" "222.200" "222.201" "222.202" "222.203" "222.204" "222.205" "222.206" "222.207" "222.208" "222.209" "222.210" "222.211" "222.212" "222.213" "222.214" "222.215" "222.216" "222.217" "222.218" "222.219" "222.220" "222.221" "222.222" "222.223" "222.240" "222.241" "222.242" "222.243" "222.244" "222.245" "222.246" "222.247" "222.248" "222.249"
    "223.0" "223.4" "223.8" "223.12" "223.16" "223.20" "223.64" "223.65" "223.66" "223.67" "223.68" "223.69" "223.70" "223.71" "223.72" "223.73" "223.74" "223.75" "223.76" "223.77" "223.78" "223.79" "223.80" "223.81" "223.82" "223.83" "223.84" "223.85" "223.86" "223.87" "223.88" "223.89" "223.90" "223.91" "223.92" "223.93" "223.94" "223.95" "223.96" "223.97" "223.98" "223.99" "223.100" "223.101" "223.102" "223.103" "223.104" "223.112" "223.113" "223.114" "223.128" "223.129" "223.144" "223.145" "223.146" "223.147" "223.148" "223.149" "223.150" "223.151" "223.152" "223.153" "223.154" "223.155" "223.156" "223.157" "223.158" "223.159" "223.160" "223.161" "223.162" "223.163" "223.164" "223.165" "223.166" "223.167" "223.192" "223.198" "223.199" "223.202" "223.203" "223.208" "223.212" "223.213" "223.214" "223.215" "223.220" "223.221" "223.222" "223.223" "223.240" "223.241" "223.242" "223.243" "223.244" "223.245" "223.246" "223.247" "223.248" "223.249" "223.250" "223.251" "223.252" "223.253" "223.254" "223.255"
    # 103.x 段（阿里云、腾讯云等云厂商）
    "103.0" "103.1" "103.2" "103.3" "103.4" "103.5" "103.6" "103.7" "103.8" "103.9" "103.10" "103.11" "103.12" "103.14" "103.16" "103.20" "103.24" "103.25" "103.26" "103.27" "103.28" "103.29" "103.30" "103.36" "103.37" "103.38" "103.39" "103.40" "103.41" "103.42" "103.43" "103.44" "103.45" "103.46" "103.48" "103.52" "103.56" "103.60" "103.192" "103.200" "103.208" "103.216" "103.224" "103.232" "103.240"

    # 139.x 段（中国移动）
    "139.0" "139.8" "139.9" "139.16" "139.17" "139.18" "139.19" "139.24" "139.32" "139.64" "139.128" "139.129" "139.148" "139.152" "139.155" "139.156" "139.159" "139.170" "139.176" "139.186" "139.189" "139.196" "139.198" "139.199" "139.200" "139.201" "139.202" "139.203" "139.204" "139.205" "139.206" "139.207" "139.208" "139.209" "139.210" "139.211" "139.212" "139.213" "139.214" "139.215" "139.216" "139.217" "139.218" "139.219" "139.220" "139.221" "139.222" "139.223" "139.224" "139.225" "139.226" "139.227"

    # 140.x 段
    "140.75" "140.143" "140.205" "140.206" "140.207" "140.210" "140.224" "140.237" "140.240" "140.243" "140.246" "140.249" "140.250" "140.255"

    # 144.x 段
    "144.0" "144.7" "144.12" "144.34" "144.48" "144.52" "144.123" "144.255"

    # 150.x 段（中国移动）
    "150.0" "150.115" "150.121" "150.128" "150.129" "150.130" "150.131" "150.136" "150.138" "150.223" "150.242" "150.248" "150.252" "150.254" "150.255"

    # 153.x 段（中国移动）
    "153.0" "153.3" "153.34" "153.35" "153.36" "153.37" "153.96" "153.99" "153.100" "153.101" "153.118"

    # 157.x 段（中国移动）
    "157.0" "157.18" "157.61" "157.122" "157.148" "157.156" "157.255"

    # 159.x 段
    "159.75" "159.226" "159.227"

    # 163.x 段（网易等）
    "163.0" "163.53" "163.125" "163.126" "163.127" "163.128" "163.142" "163.168" "163.177" "163.179" "163.204"

    # 171.x 段（中国移动）
    "171.8" "171.9" "171.10" "171.11" "171.12" "171.13" "171.14" "171.15" "171.16" "171.32" "171.33" "171.34" "171.35" "171.36" "171.37" "171.38" "171.39" "171.40" "171.41" "171.42" "171.43" "171.44" "171.45" "171.46" "171.47" "171.80" "171.81" "171.82" "171.83" "171.84" "171.85" "171.86" "171.87" "171.88" "171.89" "171.90" "171.91" "171.92" "171.93" "171.94" "171.95" "171.104" "171.105" "171.106" "171.107" "171.108" "171.109" "171.110" "171.111" "171.112" "171.113" "171.114" "171.115" "171.116" "171.117" "171.118" "171.119" "171.120" "171.121" "171.122" "171.123" "171.124" "171.125" "171.126" "171.127" "171.208" "171.209" "171.210" "171.211" "171.212" "171.213" "171.214" "171.215" "171.216" "171.217" "171.218" "171.219" "171.220" "171.221" "171.222" "171.223"

    # 175.x 段（中国电信、联通）
    "175.0" "175.1" "175.2" "175.3" "175.4" "175.5" "175.6" "175.7" "175.8" "175.9" "175.10" "175.11" "175.12" "175.13" "175.14" "175.15" "175.16" "175.17" "175.18" "175.19" "175.20" "175.21" "175.22" "175.23" "175.24" "175.25" "175.26" "175.27" "175.28" "175.29" "175.30" "175.31" "175.42" "175.43" "175.44" "175.46" "175.48" "175.64" "175.96" "175.102" "175.106" "175.146" "175.148" "175.150" "175.152" "175.160" "175.168" "175.176" "175.178" "175.184" "175.185" "175.186" "175.187" "175.188" "175.189" "175.190" "175.191"

    # 176.x 段（部分中国段）
    "176.119"

    # 183.x 段补充
    "183.28" "183.30" "183.32" "183.34" "183.36" "183.38" "183.40" "183.42" "183.44" "183.46" "183.48" "183.50" "183.52" "183.54"

    # 185.x 段（部分中国云厂商）
    "185.212" "185.228"

    # 202.x 段补充
    "202.0" "202.4" "202.8" "202.12" "202.14" "202.38" "202.40" "202.41" "202.43" "202.46" "202.56" "202.60" "202.66" "202.69" "202.75" "202.85" "202.86" "202.90" "202.91" "202.92" "202.93" "202.94" "202.95" "202.113" "202.114" "202.115" "202.116" "202.117" "202.118" "202.119" "202.120" "202.121" "202.122" "202.124" "202.126" "202.127" "202.128" "202.130" "202.131" "202.134" "202.136" "202.141" "202.148" "202.149" "202.160" "202.165" "202.168" "202.173" "202.180" "202.181" "202.189" "202.192" "202.193" "202.194" "202.195" "202.196" "202.197" "202.198" "202.199" "202.200" "202.201" "202.202" "202.203" "202.204" "202.205" "202.206" "202.207"

    # 203.x 段
    "203.0" "203.2" "203.4" "203.6" "203.8" "203.12" "203.13" "203.14" "203.15" "203.16" "203.17" "203.19" "203.20" "203.21" "203.22" "203.24" "203.25" "203.29" "203.32" "203.34" "203.55" "203.57" "203.69" "203.80" "203.81" "203.86" "203.88" "203.90" "203.91" "203.92" "203.93" "203.94" "203.95" "203.99" "203.100" "203.104" "203.107" "203.110" "203.119" "203.128" "203.130" "203.134" "203.135" "203.142" "203.148" "203.152" "203.156" "203.160" "203.161" "203.166" "203.168" "203.171" "203.174" "203.175" "203.176" "203.184" "203.187" "203.189" "203.190" "203.191" "203.192" "203.195" "203.196" "203.207" "203.208" "203.212" "203.222" "203.223"

    # 210.x 段补充
    "210.2" "210.4" "210.6" "210.7" "210.8" "210.15" "210.16" "210.17" "210.18" "210.19" "210.20" "210.23" "210.24" "210.33" "210.48" "210.49" "210.50" "210.54" "210.56" "210.72" "210.73" "210.74" "210.75" "210.76" "210.77" "210.78" "210.79" "210.82" "210.83"

    # 211.x 段补充
    "211.0" "211.1" "211.2" "211.3" "211.4" "211.5" "211.6" "211.7" "211.8" "211.9" "211.10" "211.11" "211.12" "211.13" "211.14" "211.15" "211.16" "211.17" "211.20" "211.21" "211.22" "211.23" "211.24" "211.28" "211.32" "211.36" "211.40" "211.44" "211.48" "211.52" "211.56" "211.60" "211.103" "211.104" "211.105" "211.106" "211.107" "211.108" "211.109" "211.110" "211.112" "211.120" "211.128" "211.132" "211.162" "211.163" "211.164" "211.165" "211.166" "211.167"

    # 212.x 段（部分中国）
    "212.64" "212.129"

    # 218.x 段补充
    "218.13" "218.14" "218.15" "218.16" "218.17" "218.18" "218.19" "218.31" "218.32" "218.48" "218.49" "218.50" "218.51" "218.52" "218.53" "218.54" "218.55" "218.95" "218.96" "218.97" "218.98" "218.99" "218.100" "218.101" "218.102" "218.103" "218.105" "218.106" "218.107" "218.109" "218.192" "218.200" "218.240" "218.241" "218.242" "218.243" "218.244" "218.245" "218.246" "218.247"

    # 219.x 段补充
    "219.0" "219.64" "219.65" "219.66" "219.67" "219.68" "219.69" "219.70" "219.71" "219.72" "219.73" "219.74" "219.75" "219.76" "219.77" "219.78" "219.79" "219.80" "219.81" "219.82" "219.83" "219.84" "219.85" "219.86" "219.87" "219.88" "219.89" "219.90" "219.91" "219.92" "219.93" "219.94" "219.95" "219.96" "219.97" "219.98" "219.99" "219.100" "219.101" "219.102" "219.103" "219.104" "219.112" "219.113" "219.114" "219.115" "219.116" "219.117" "219.118" "219.119" "219.120" "219.121" "219.122" "219.123" "219.124" "219.125" "219.126" "219.127" "219.160" "219.161" "219.192" "219.216" "219.217" "219.218" "219.219" "219.220" "219.221" "219.222" "219.223" "219.224" "219.225" "219.226" "219.227" "219.228" "219.229" "219.230" "219.231" "219.232" "219.233" "219.234" "219.235" "219.236" "219.237" "219.238" "219.239" "219.240" "219.241" "219.242" "219.243" "219.244" "219.245" "219.246" "219.247"

    # 220.x 段补充
    "220.0" "220.96" "220.97" "220.98" "220.99" "220.100" "220.101" "220.102" "220.103" "220.104" "220.105" "220.106" "220.107" "220.108" "220.109" "220.110" "220.111" "220.116" "220.117" "220.118" "220.119" "220.120" "220.121" "220.128" "220.129" "220.130" "220.131" "220.132" "220.133" "220.134" "220.135" "220.136" "220.137" "220.138" "220.139" "220.140" "220.141" "220.142" "220.143" "220.144" "220.152" "220.153" "220.154" "220.155" "220.156" "220.157" "220.158" "220.159" "220.199" "220.208" "220.209" "220.210" "220.211" "220.212" "220.213" "220.214" "220.215" "220.216" "220.217" "220.218" "220.219" "220.220" "220.221" "220.222" "220.223" "220.224" "220.225" "220.226" "220.227" "220.228" "220.229" "220.230" "220.231" "220.232" "220.233" "220.234" "220.235" "220.236" "220.237" "220.238" "220.239" "220.240" "220.241" "220.242" "220.243" "220.244" "220.245" "220.246" "220.247" "220.253" "220.254" "220.255"

    # 221.x 段补充
    "221.16" "221.17" "221.18" "221.19" "221.20" "221.21" "221.22" "221.23" "221.24" "221.25" "221.26" "221.27" "221.28" "221.29" "221.30" "221.31" "221.32" "221.33" "221.34" "221.35" "221.36" "221.37" "221.38" "221.39" "221.40" "221.41" "221.42" "221.43" "221.44" "221.45" "221.46" "221.47" "221.48" "221.49" "221.50" "221.51" "221.52" "221.53" "221.54" "221.55" "221.56" "221.57" "221.58" "221.59" "221.60" "221.61" "221.62" "221.63" "221.64" "221.65" "221.66" "221.67" "221.68" "221.69" "221.70" "221.71" "221.72" "221.73" "221.74" "221.75" "221.76" "221.77" "221.78" "221.79" "221.80" "221.81" "221.82" "221.83" "221.84" "221.85" "221.86" "221.87" "221.88" "221.89" "221.90" "221.91" "221.92" "221.93" "221.94" "221.95" "221.96" "221.97" "221.98" "221.99" "221.100" "221.101" "221.102" "221.103" "221.104" "221.105" "221.106" "221.107" "221.108" "221.109" "221.110" "221.111" "221.112" "221.113" "221.114" "221.115" "221.116" "221.117" "221.118" "221.119" "221.120" "221.121" "221.132" "221.133" "221.134" "221.135" "221.136" "221.137" "221.138" "221.139" "221.140" "221.141" "221.142" "221.143" "221.144" "221.145" "221.146" "221.147" "221.148" "221.149" "221.150" "221.151" "221.152" "221.153" "221.154" "221.155" "221.156" "221.157" "221.158" "221.159" "221.160" "221.161" "221.162" "221.163" "221.164" "221.165" "221.166" "221.167" "221.168" "221.169" "221.170" "221.171" "221.173" "221.174" "221.175" "221.177" "221.184" "221.185" "221.186" "221.187" "221.188" "221.189" "221.190" "221.191" "221.193" "221.197" "221.205" "221.209" "221.239"

    # 222.x 段补充
    "222.0" "222.1" "222.2" "222.3" "222.4" "222.5" "222.6" "222.7" "222.8" "222.9" "222.10" "222.11" "222.12" "222.13" "222.14" "222.15" "222.30" "222.31" "222.33" "222.75" "222.81" "222.94" "222.95" "222.96" "222.97" "222.98" "222.99" "222.100" "222.101" "222.102" "222.103" "222.104" "222.105" "222.106" "222.107" "222.108" "222.109" "222.110" "222.111" "222.112" "222.113" "222.114" "222.115" "222.116" "222.117" "222.118" "222.119" "222.120" "222.121" "222.122" "222.123" "222.124" "222.127" "222.144" "222.145" "222.146" "222.147" "222.148" "222.149" "222.150" "222.151" "222.152" "222.153" "222.154" "222.155" "222.156" "222.157" "222.158" "222.159" "222.162" "222.163" "222.164" "222.165" "222.166" "222.167" "222.224" "222.225" "222.226" "222.227" "222.228" "222.229" "222.230" "222.231" "222.232" "222.233" "222.234" "222.235" "222.236" "222.237" "222.238" "222.239" "222.250" "222.251" "222.252" "222.253" "222.254" "222.255"

    # 223.x 段补充
    "223.1" "223.2" "223.3" "223.5" "223.6" "223.7" "223.9" "223.10" "223.11" "223.13" "223.14" "223.15" "223.17" "223.18" "223.19" "223.21" "223.22" "223.24" "223.25" "223.26" "223.27" "223.28" "223.29" "223.30" "223.31" "223.32" "223.36" "223.37" "223.38" "223.39" "223.40" "223.41" "223.42" "223.43" "223.44" "223.45" "223.46" "223.47" "223.48" "223.52" "223.53" "223.54" "223.55" "223.56" "223.57" "223.58" "223.59" "223.60" "223.61" "223.62" "223.63" "223.105" "223.106" "223.107" "223.108" "223.109" "223.110" "223.111" "223.115" "223.116" "223.117" "223.118" "223.119" "223.120" "223.121" "223.122" "223.123" "223.124" "223.125" "223.126" "223.127" "223.130" "223.131" "223.132" "223.133" "223.134" "223.135" "223.136" "223.137" "223.138" "223.139" "223.140" "223.141" "223.142" "223.143" "223.168" "223.169" "223.170" "223.171" "223.172" "223.173" "223.174" "223.175" "223.176" "223.177" "223.178" "223.179" "223.180" "223.181" "223.182" "223.183" "223.184" "223.185" "223.186" "223.187" "223.188" "223.189" "223.190" "223.191" "223.193" "223.194" "223.195" "223.196" "223.197" "223.200" "223.201" "223.204" "223.205" "223.206" "223.207" "223.209" "223.210" "223.211" "223.216" "223.217" "223.218" "223.219" "223.224" "223.225" "223.226" "223.227" "223.228" "223.229" "223.230" "223.231" "223.232" "223.233" "223.234" "223.235" "223.236" "223.237" "223.238" "223.239"

    # 240.x - 255.x 段（保留段，但部分在中国使用）
    "240.0" "240.1"
)

# ========== 百度蜘蛛 IP 段（永不封禁）==========
BAIDU_RANGES=(
    "116.179" "220.181" "119.63" "180.76" "123.125" "61.135" "202.108" "111.206" "182.61" "106.12"
)

# ========== Cloudflare IP 段（永不封禁）==========
CLOUDFLARE_RANGES=(
    "173.245" "103.21" "103.22" "103.31" "141.101" "108.162" "190.93" "188.114" "197.234" "198.41" "162.158" "162.159" "104.16" "104.17" "104.18" "104.19" "104.20" "104.21" "104.22" "104.23" "104.24" "104.25" "104.26" "104.27" "172.64" "172.65" "172.66" "172.67" "172.68" "172.69" "172.70" "172.71" "131.0"
)

# ========== 判断是否为中国 IP ==========
is_china_ip() {
    local ip=$1
    local prefix=$(echo "$ip" | cut -d'.' -f1-2)
    
    for cn_prefix in "${CHINA_IP_PREFIXES[@]}"; do
        if [[ "$prefix" == "$cn_prefix" ]]; then
            return 0  # 是中国 IP
        fi
    done
    return 1  # 不是中国 IP
}

# ========== 判断是否为百度 IP ==========
is_baidu_ip() {
    local ip=$1
    local prefix=$(echo "$ip" | cut -d'.' -f1-2)
    
    for baidu_prefix in "${BAIDU_RANGES[@]}"; do
        if [[ "$prefix" == "$baidu_prefix" ]]; then
            return 0
        fi
    done
    return 1
}

# ========== 判断是否为 Cloudflare IP ==========
is_cloudflare_ip() {
    local ip=$1
    local prefix=$(echo "$ip" | cut -d'.' -f1-2)
    
    for cf_prefix in "${CLOUDFLARE_RANGES[@]}"; do
        if [[ "$prefix" == "$cf_prefix" ]]; then
            return 0
        fi
    done
    return 1
}

# ========== 将单个 IP 转换为 C 段 ==========
ip_to_c_block() {
    local ip=$1
    echo "${ip%.*}.0/24"
}

# ========== 将单个 IP 转换为 B 段 ==========
ip_to_b_block() {
    local ip=$1
    local parts=(${ip//./ })
    echo "${parts[0]}.${parts[1]}.0.0/16"
}

# ========== 智能处理 IP ==========
# 国外 IP -> C段
# 国内 IP -> 保持原样
smart_process_ip() {
    local ip=$1
    
    # 如果已经是 CIDR 格式，直接返回
    if [[ "$ip" == *"/"* ]]; then
        echo "$ip"
        return
    fi
    
    # 跳过百度和 Cloudflare
    if is_baidu_ip "$ip" || is_cloudflare_ip "$ip"; then
        echo "SKIP"
        return
    fi
    
    # 中国 IP -> 保持原样
    if is_china_ip "$ip"; then
        echo "$ip"
        return
    fi
    
    # 国外 IP -> 转为 C 段
    ip_to_c_block "$ip"
}

# ========== 缓存已有的 iptables 规则（提升效率）==========
echo ""
echo "正在缓存已有的 iptables 规则..."
declare -A EXISTING_RULES  # 已存在的规则
declare -A NEW_IPS         # 本次要新增的 IP

# 提取所有已有的 DROP 规则到内存
while read -r line; do
    # 提取 IP/CIDR
    ip=$(echo "$line" | grep -oP '\d+\.\d+\.\d+\.\d+(/\d+)?')
    if [[ -n "$ip" ]]; then
        EXISTING_RULES["$ip"]=1
    fi
done <<< "$(iptables -L INPUT -n | grep DROP)"

EXISTING_COUNT=${#EXISTING_RULES[@]}
echo -e "${GREEN}已缓存 $EXISTING_COUNT 条现有规则${NC}"

# ========== 下载并处理黑名单 ==========
TOTAL_NEW=0
TOTAL_EXIST=0
TOTAL_SKIPPED=0
TOTAL_WHITELIST_SKIP=0

echo ""
echo -e "${CYAN}智能处理策略：${NC}"
echo "  - 国外单个 IP → 扩展为 C 段 (/24)"
echo "  - 国内单个 IP → 保持原样（避免误封）"
echo "  - CIDR 网段 → 原样封禁"
echo "  - 百度/Cloudflare → 跳过"
echo "  - 已存在规则 → 跳过（高效去重）"
echo ""

for list_info in "${BLOCKLISTS[@]}"; do
    IFS='|' read -r url type name <<< "$list_info"
    
    echo ""
    echo "=========================================="
    echo "正在处理: $name ($type)"
    echo "=========================================="
    
    # 下载列表
    temp_file="$TEMP_DIR/${name}.txt"
    if curl -s --connect-timeout 15 --max-time 60 "$url" -o "$temp_file" 2>/dev/null; then
        # 根据类型提取 IP
        if [[ "$type" == "ipsum" ]]; then
            # ipsum 格式: 纯 IP（每行一个，可能有额外信息需要过滤）
            ip_list=$(grep -v "^#" "$temp_file" | grep -v "^$" | grep -oE "^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+")
        elif [[ "$type" == "netset" ]]; then
            # netset 格式: CIDR 网段（如 1.2.3.0/24）
            ip_list=$(grep -v "^#" "$temp_file" | grep -v "^$" | grep -E "^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(/[0-9]+)?$")
        elif [[ "$type" == "ipset" ]]; then
            # ipset 格式: 单个 IP（每行一个）
            ip_list=$(grep -v "^#" "$temp_file" | grep -v "^$" | grep -E "^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$")
        else
            # 通用格式: 提取所有 IP 或 CIDR
            ip_list=$(grep -v "^#" "$temp_file" | grep -v "^$" | grep -oE "[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(/[0-9]+)?")
        fi
        ip_count=$(echo "$ip_list" | grep -c . 2>/dev/null || echo 0)
        
        echo "下载成功: $ip_count 条记录"
        
        new_count=0
        exist_count=0
        skipped=0
        expanded=0
        whitelist_skip=0
        
        # 处理每个 IP（限制数量）
        while read -r ip; do
            # 跳过空行
            [[ -z "$ip" ]] && continue
            
            # 智能处理
            processed_ip=$(smart_process_ip "$ip")
            
            # 跳过标记（百度/CF）
            if [[ "$processed_ip" == "SKIP" ]]; then
                ((skipped++))
                continue
            fi
            
            # ★★★ 检查是否在白名单中 ★★★
            if is_whitelisted "$processed_ip"; then
                ((whitelist_skip++))
                # 记录被白名单保护的 IP
                echo "$processed_ip # 来源: $name, 原始: $ip" >> "$WHITELIST_SKIP_LOG"
                continue
            fi
            
            # 检查是否已在本次处理中（去重）
            if [[ -n "${NEW_IPS[$processed_ip]}" ]]; then
                continue
            fi
            
            # 检查是否已在现有规则中（高效内存查询）
            if [[ -n "${EXISTING_RULES[$processed_ip]}" ]]; then
                ((exist_count++))
                continue
            fi
            
            # 标记为新 IP
            NEW_IPS[$processed_ip]=1
            
            # 统计是否扩展了
            if [[ "$ip" != "$processed_ip" && "$ip" != *"/"* ]]; then
                ((expanded++))
            fi
            
            ((new_count++))
            
        done <<< "$(echo "$ip_list" | head -5000)"
        
        echo -e "  新发现: ${GREEN}$new_count${NC}, 已存在: ${YELLOW}$exist_count${NC}, 扩展C段: $expanded, 跳过: $skipped, 白名单保护: $whitelist_skip"
        TOTAL_NEW=$((TOTAL_NEW + new_count))
        TOTAL_EXIST=$((TOTAL_EXIST + exist_count))
        TOTAL_SKIPPED=$((TOTAL_SKIPPED + skipped))
        TOTAL_WHITELIST_SKIP=$((TOTAL_WHITELIST_SKIP + whitelist_skip))
    else
        echo -e "${RED}[失败]${NC} 无法下载 $name"
    fi
done

# ========== 批量添加新规则 ==========
echo ""
echo "=========================================="
echo "批量添加新规则..."
echo "=========================================="

NEW_IPS_COUNT=${#NEW_IPS[@]}
echo "待添加: $NEW_IPS_COUNT 条新规则"

# 记录本次新增的所有 IP 到日志
echo "# ========================================" >> "$NEW_IPS_LOG"
echo "# 新增封禁 IP 列表" >> "$NEW_IPS_LOG"
echo "# 时间: $DATE" >> "$NEW_IPS_LOG"
echo "# 数量: $NEW_IPS_COUNT" >> "$NEW_IPS_LOG"
echo "# ========================================" >> "$NEW_IPS_LOG"

if [[ $NEW_IPS_COUNT -gt 0 ]]; then
    added=0
    for ip in "${!NEW_IPS[@]}"; do
        # 获取 ctstate 规则的行号，在其前面插入 DROP 规则
        insert_line=$(get_insert_line)
        if [[ -n "$insert_line" && "$insert_line" =~ ^[0-9]+$ ]]; then
            iptables -I INPUT "$insert_line" -s "$ip" -j DROP
        else
            iptables -A INPUT -s "$ip" -j DROP
        fi
        # 记录到日志文件
        echo "$ip" >> "$NEW_IPS_LOG"
        ((added++))
        # 每添加 100 条显示进度
        if [[ $((added % 100)) -eq 0 ]]; then
            echo -ne "\r已添加: $added / $NEW_IPS_COUNT"
        fi
    done
    echo -e "\r${GREEN}[完成]${NC} 成功添加 $added 条新规则"
else
    echo -e "${YELLOW}没有新规则需要添加${NC}"
fi

# ========== 保存规则 ==========
echo ""
echo "=========================================="
echo "保存 iptables 规则..."
echo "=========================================="

iptables-save > /etc/sysconfig/iptables
RULES_COUNT=$(iptables -L INPUT -n | grep DROP | wc -l)

echo -e "${GREEN}[完成]${NC} 规则已保存"
echo "当前 DROP 规则数量: $RULES_COUNT"

# ========== 确保重启后自动加载（CentOS）==========
echo ""
echo "=========================================="
echo "检查 iptables 服务状态..."
echo "=========================================="

# 检查是否安装了 iptables-services
if ! rpm -q iptables-services &>/dev/null; then
    echo -e "${YELLOW}[提示]${NC} iptables-services 未安装，正在安装..."
    yum install -y iptables-services &>/dev/null
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}[完成]${NC} iptables-services 安装成功"
    else
        echo -e "${RED}[警告]${NC} iptables-services 安装失败，请手动安装: yum install -y iptables-services"
    fi
fi

# 启用 iptables 服务开机自启
if systemctl is-enabled iptables &>/dev/null; then
    echo -e "${GREEN}[正常]${NC} iptables 服务已设置开机自启"
else
    echo "正在启用 iptables 服务开机自启..."
    systemctl enable iptables &>/dev/null
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}[完成]${NC} iptables 服务已启用开机自启"
    else
        echo -e "${RED}[警告]${NC} 启用失败，请手动执行: systemctl enable iptables"
    fi
fi

# 确保 iptables 服务正在运行
if systemctl is-active iptables &>/dev/null; then
    echo -e "${GREEN}[正常]${NC} iptables 服务正在运行"
else
    echo "正在启动 iptables 服务..."
    systemctl start iptables &>/dev/null
    echo -e "${GREEN}[完成]${NC} iptables 服务已启动"
fi

# ========== 清理 ==========
rm -rf "$TEMP_DIR"

# ========== 统计 ==========
echo ""
echo "=========================================="
echo -e "${GREEN}更新完成统计${NC}"
echo "=========================================="
echo "时间: $DATE"
echo ""
echo "处理结果："
echo "  - 原有规则数: $EXISTING_COUNT"
echo "  - 本次新增:   $NEW_IPS_COUNT"
echo "  - 已存在跳过: $TOTAL_EXIST"
echo "  - 百度/CF跳过: $TOTAL_SKIPPED"
echo "  - 白名单保护: $TOTAL_WHITELIST_SKIP"
echo "  - 当前总规则: $RULES_COUNT"
echo ""
echo "服务器状态："
echo "  - 负载: $(uptime | awk -F'load average:' '{print $2}')"
echo "=========================================="

# ========== 保存详细日志 ==========
echo ""
echo "=========================================="
echo "保存日志文件..."
echo "=========================================="

# 保存摘要日志
cat > "$SUMMARY_LOG" << EOF
==========================================
IP 封禁自动更新 - 运行摘要
==========================================
运行时间: $DATE
日志目录: $DAILY_LOG_DIR

------------------------------------------
处理统计
------------------------------------------
原有规则数:     $EXISTING_COUNT
本次新增:       $NEW_IPS_COUNT
已存在跳过:     $TOTAL_EXIST
百度/CF跳过:    $TOTAL_SKIPPED
白名单保护:     $TOTAL_WHITELIST_SKIP
当前总规则:     $RULES_COUNT

------------------------------------------
日志文件
------------------------------------------
新增封禁IP:     $NEW_IPS_LOG
白名单保护IP:   $WHITELIST_SKIP_LOG
本摘要文件:     $SUMMARY_LOG

------------------------------------------
服务器状态
------------------------------------------
负载: $(uptime | awk -F'load average:' '{print $2}')
内存: $(free -h | awk '/^Mem:/ {print $3 "/" $2}')
磁盘: $(df -h / | awk 'NR==2 {print $3 "/" $2 " (" $5 ")"}')
==========================================
EOF

echo -e "${GREEN}[完成]${NC} 日志已保存到: $DAILY_LOG_DIR"
echo "  - 新增封禁IP: $NEW_IPS_LOG"
echo "  - 白名单保护: $WHITELIST_SKIP_LOG"
echo "  - 运行摘要:   $SUMMARY_LOG"

# 记录到主日志
echo "[$DATE] 新增: $NEW_IPS_COUNT, 跳过: $TOTAL_EXIST, 白名单保护: $TOTAL_WHITELIST_SKIP, 总规则: $RULES_COUNT, 日志: $DAILY_LOG_DIR" >> "$LOG_FILE"

# ========== 清理旧日志（保留30天）==========
find "$LOG_DIR" -type d -mtime +30 -exec rm -rf {} \; 2>/dev/null

echo ""
echo -e "${GREEN}全部完成！${NC}"
echo "=========================================="

exit 0
